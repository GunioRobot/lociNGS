#!/usr/bin/python
# Filename: samIndexMDB.py for lociNGS
# shird; 27 may 2011
<<<<<<< HEAD
#this script requires a directory of indexed bam files (i.e., a .bam and a .bam.bai file per individual)
#from the directory, a mongoDB database (created with the locusIndexMDB.py script) is updated to include how many reads align to each locus in a reference genome
#takes directory of bam files as argument


=======

import fnmatch
>>>>>>> 9bd43c10e2682b3b6a9535e1b07f8272f09750af
import pysam
import argparse
import os
import pymongo
import re
<<<<<<< HEAD
from Bio import SeqIO
from pymongo import Connection

#for getting a connection to MongoDB via pymongo
connection = Connection()
db = connection.test_database
loci = db.loci
demographic = db.demographic

#get path to the bam directory
=======
import json
import simplejson
from seqlite_mod import SNPnumber
from Bio import SeqIO
from pymongo import Connection

def iter():
	for item in cursor:
		yield item

#for getting a connection to MongoDB via pymongo
connection = Connection()
db = connection.test_database
collection = db.loci

>>>>>>> 9bd43c10e2682b3b6a9535e1b07f8272f09750af
parser = argparse.ArgumentParser(description='Get path to bam files.')
parser.add_argument('path',help='give the program the path to the folder of locus files')
args = parser.parse_args()
print 'Got this folder:', args.path
bam_library = os.listdir(args.path)
<<<<<<< HEAD
bamPath = {"bamPath" : args.path }
db.loci.insert(bamPath)

#for each .bam file, count how many reads/locus and add to correct document in mongoDB
for bam in bam_library:
	if bam.endswith(".bam"):
		file = os.path.join(args.path, bam)
		print 'Got this file: ', file
###will need to index the bam files if not already done?
		samfile = pysam.Samfile(file, "rb")
		print samfile.nreferences   #prints number of loci
		allLoci = samfile.references
		currentName = re.sub('/.+/', '', file)
		currentName = re.sub('.sorted.bam','', currentName)
		namePath = "individuals."+currentName
		countView = pysam.view("-c",file)  #counts number of reads in bam file
		for line in countView:
			line = line.strip() 
		print "line is now ", line
		db.demographic.update( {"Individual" : currentName }, { '$set' : { "totalReads" : line } } )		

#this counts the matches of reads to a given locus in allLoci, adds 1 for each match then updates MDB
		for n in allLoci:   #foreach locus in the allLoci list
			count = 0
			for alignedread in samfile.fetch(n):
=======
#print fasta_library

#print data to post collection in mongoDB
for bam in bam_library:
	if fnmatch.fnmatch(bam, '*.bam'):
		file = os.path.join(args.path, bam)
		print 'Got this file: ', file
###will need to index the bam files if not already done?

		samfile = pysam.Samfile(file, "rb")

		print samfile.nreferences   #prints number of loci
		allLoci = samfile.references

		currentName = re.sub('/.+/', '', file)
		currentName = re.sub('.sorted.bam','', currentName)

		namePath = "individuals."+currentName

		print currentName
		print namePath

		for n in allLoci:
			count = 0
			for alignedread in samfile.fetch(n):
			#	print alignedread.seq
>>>>>>> 9bd43c10e2682b3b6a9535e1b07f8272f09750af
				count = count + 1
			m = re.sub('.+\|.+\|','',n)	
			if count>0:
				db.loci.update( {"locusNumber" : m }, { '$inc' : { namePath : count } } )
<<<<<<< HEAD
				print n, count  #can turn this off to quicken script - prints every locus and it's count

samfile.close()
=======
				print n, count
		



# re.sub('^+.|.+|','',n)









#cursor = db.loci.find({ namePath : 0 }, {'locusNumber' : 1, "_id" : 0})
#print "cursor", db.loci.find(cursor.next())
				
#dictFromJSON = []				
#for x in iter():
#	dictFromJSON.append(json.dumps(x))
#	print x, "x in iter"
#	cursor2 = db.loci.find(x)
	
	
#print "dictFromJSON ", dictFromJSON

#for key in range(len(dictFromJSON)):
#	print key, "memberOfList dictFromJSON", dictFromJSON[key]



#######PUT LIST MEMBERS INTO A QUERY########


for n in allLoci:
	count = 0
	for alignedread in samfile.fetch(n):
	#	print alignedread.seq
		count = count + 1
	print n, count

#set locus to locusname
#set individual to individual
#search mongo for locus and individual
#update with count

#for name in lines:
#	name1 = "individuals."+name
#	print "name: ", name, "found in: ", db.loci.find({ name1 : 0 } ).count(), "loci"

#db.loci.update({"path": '*.fasta'}, {"$set" : {"numReads2" : 344}})

#SAMindividual = {"locus":fasta, "individuals":loci_dict.keys(), "length": len(loci_dict[loci_dict.keys()[0]]), "path": file, "SNPs" : SNP }   #, "length":len(loci_dict.keys()[0].seq)}
#loci = db.loci
#loci.individuals = { "numReads" : count }

#db.loci.update( {"individuals" : 
#db.loci.insert(locus)
#print "locus = ", re.sub(".fasta","",fasta), "; number alleles = ", len(loci_dict), "; length = ", len(loci_dict[loci_dict.keys()[0]])  , "; path = ", file, "; SNPs = ",SNP
	


samfile.close()




#get path from commandline - right now just doing single file but will upgrade to directory after working out the subsequent code
#parser = argparse.ArgumentParser(description='Get path to a bam file.')
#parser.add_argument('path',help='give the program the path to the folder of locus files')
#args = parser.parse_args()
#print 'Got this file:', args.path
>>>>>>> 9bd43c10e2682b3b6a9535e1b07f8272f09750af
